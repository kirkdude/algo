#!/bin/bash
# Test script for liboqs post-quantum algorithms
# Generated by Ansible for Algo Quantum VPN

set -e

LIBOQS_BUILD_DIR="{{ liboqs_build_dir }}"
TEST_RESULTS="/opt/quantum-safe/logs/liboqs-test-$(date +%Y%m%d_%H%M%S).log"

echo "=== liboqs Algorithm Testing ===" | tee "$TEST_RESULTS"
echo "Timestamp: $(date)" | tee -a "$TEST_RESULTS"
echo "liboqs Version: {{ liboqs_version }}" | tee -a "$TEST_RESULTS"
echo "Build Directory: $LIBOQS_BUILD_DIR" | tee -a "$TEST_RESULTS"
echo "" | tee -a "$TEST_RESULTS"

# Test ML-KEM algorithms
echo "Testing ML-KEM (Key Encapsulation Mechanism) algorithms..." | tee -a "$TEST_RESULTS"
{% for algorithm in quantum_safe_algorithms.ml_kem %}
echo -n "Testing {{ algorithm }}... " | tee -a "$TEST_RESULTS"
if "$LIBOQS_BUILD_DIR/tests/test_kem" "{{ algorithm }}" &>/dev/null; then
    echo "PASS" | tee -a "$TEST_RESULTS"
else
    echo "FAIL" | tee -a "$TEST_RESULTS"
    exit 1
fi
{% endfor %}

# Test ML-DSA algorithms
echo "" | tee -a "$TEST_RESULTS"
echo "Testing ML-DSA (Digital Signature Algorithm) algorithms..." | tee -a "$TEST_RESULTS"
{% for algorithm in quantum_safe_algorithms.ml_dsa %}
echo -n "Testing {{ algorithm }}... " | tee -a "$TEST_RESULTS"
if "$LIBOQS_BUILD_DIR/tests/test_sig" "{{ algorithm }}" &>/dev/null; then
    echo "PASS" | tee -a "$TEST_RESULTS"
else
    echo "FAIL" | tee -a "$TEST_RESULTS"
    exit 1
fi
{% endfor %}

# Performance test for default algorithm
echo "" | tee -a "$TEST_RESULTS"
echo "Running performance test for {{ default_security_level }}..." | tee -a "$TEST_RESULTS"
if "$LIBOQS_BUILD_DIR/tests/speed_kem" "{{ default_security_level }}" | head -20 | tee -a "$TEST_RESULTS"; then
    echo "Performance test completed successfully" | tee -a "$TEST_RESULTS"
else
    echo "Performance test failed" | tee -a "$TEST_RESULTS"
    exit 1
fi

echo "" | tee -a "$TEST_RESULTS"
echo "=== All liboqs tests completed successfully ===" | tee -a "$TEST_RESULTS"
echo "Full results saved to: $TEST_RESULTS"
