#!/bin/bash
# strongSwan Post-Quantum Cryptography Test Script
# Generated by Algo VPN quantum-safe role

set -euo pipefail

STRONGSWAN_BIN="{{ strongswan_install_dir }}/sbin"
SWANCTL_BIN="{{ strongswan_install_dir }}/sbin/swanctl"
TEST_LOG="/opt/quantum-safe/tests/strongswan-pq-test.log"

echo "=== strongSwan Post-Quantum Cryptography Test ===" | tee "$TEST_LOG"
echo "Timestamp: $(date)" | tee -a "$TEST_LOG"
echo | tee -a "$TEST_LOG"

# Test 1: Check if strongSwan is installed
echo "Test 1: strongSwan Installation" | tee -a "$TEST_LOG"
if [ -f "${STRONGSWAN_BIN}/ipsec" ]; then
    echo "✓ strongSwan binary found" | tee -a "$TEST_LOG"
    VERSION=$(${STRONGSWAN_BIN}/ipsec version 2>/dev/null | head -1 || echo "Version check failed")
    echo "  Version: $VERSION" | tee -a "$TEST_LOG"
else
    echo "✗ strongSwan binary not found at ${STRONGSWAN_BIN}/ipsec" | tee -a "$TEST_LOG"
    echo "FAIL: strongSwan not properly installed" | tee -a "$TEST_LOG"
    exit 1
fi
echo | tee -a "$TEST_LOG"

# Test 2: Check if liboqs is available
echo "Test 2: LibOQS Integration" | tee -a "$TEST_LOG"
if [ -f "/usr/local/lib/liboqs.so" ]; then
    echo "✓ LibOQS library found" | tee -a "$TEST_LOG"
else
    echo "✗ LibOQS library not found" | tee -a "$TEST_LOG"
fi
echo | tee -a "$TEST_LOG"

# Test 3: Check available algorithms
echo "Test 3: Available Key Exchange Algorithms" | tee -a "$TEST_LOG"
if [ -f "${SWANCTL_BIN}" ]; then
    echo "Available algorithms:" | tee -a "$TEST_LOG"
    ${SWANCTL_BIN} --list-algs 2>/dev/null | grep -E "(kem|KEM|ML-KEM|mlkem)" | tee -a "$TEST_LOG" || {
        echo "  No ML-KEM algorithms found" | tee -a "$TEST_LOG"
    }
else
    echo "✗ swanctl binary not found" | tee -a "$TEST_LOG"
fi
echo | tee -a "$TEST_LOG"

# Test 4: Check strongSwan service status
echo "Test 4: strongSwan Service Status" | tee -a "$TEST_LOG"
if systemctl is-enabled strongswan >/dev/null 2>&1; then
    echo "✓ strongSwan service is enabled" | tee -a "$TEST_LOG"
    if systemctl is-active strongswan >/dev/null 2>&1; then
        echo "✓ strongSwan service is running" | tee -a "$TEST_LOG"
    else
        echo "⚠ strongSwan service is not running" | tee -a "$TEST_LOG"
    fi
else
    echo "⚠ strongSwan service is not enabled" | tee -a "$TEST_LOG"
fi
echo | tee -a "$TEST_LOG"

# Test 5: Configuration file validation
echo "Test 5: Configuration Files" | tee -a "$TEST_LOG"
CONFIG_FILES=(
    "/etc/ipsec.conf"
    "/etc/ipsec.secrets"
    "/etc/swanctl/swanctl.conf"
)

for config in "${CONFIG_FILES[@]}"; do
    if [ -f "$config" ]; then
        echo "✓ $config exists" | tee -a "$TEST_LOG"
    else
        echo "⚠ $config not found" | tee -a "$TEST_LOG"
    fi
done
echo | tee -a "$TEST_LOG"

echo "=== strongSwan Post-Quantum Test Complete ===" | tee -a "$TEST_LOG"
echo "Log saved to: $TEST_LOG" | tee -a "$TEST_LOG"

# Return success if basic installation is working
if [ -f "${STRONGSWAN_BIN}/ipsec" ]; then
    echo "Test Result: PASS - Basic strongSwan installation verified"
    exit 0
else
    echo "Test Result: FAIL - strongSwan installation incomplete"
    exit 1
fi
