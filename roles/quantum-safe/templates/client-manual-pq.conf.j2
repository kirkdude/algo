# Manual Quantum-Safe IPsec Configuration
# User: {{ item }}
# Server: {{ IP_subject_alt_name }}
# Generated by Algo VPN quantum-safe role

# strongSwan Configuration for {{ item }}
# Place this in /etc/ipsec.conf or include in swanctl.conf

connections {
    algovpn-pq-{{ item }} {
        version = 2

        # Quantum-safe proposals
{% if quantum_safe_mode == 'hybrid' %}
        proposals = {{ ciphers.quantum_safe.hybrid.ike }}
        esp_proposals = {{ ciphers.quantum_safe.hybrid.esp }}
{% else %}
        proposals = {{ ciphers.defaults.ike }}
        esp_proposals = {{ ciphers.defaults.esp }}
{% endif %}

        # Timing
        reauth_time = 12h
        life_time = 3h

        # Fragmentation and DPD
        fragmentation = yes
        dpd_action = clear
        dpd_delay = 35s

        # Server
        remote_addrs = {{ IP_subject_alt_name }}
        remote {
            auth = pubkey
            id = {{ IP_subject_alt_name }}
        }

        # Client
        local {
            auth = pubkey
            certs = {{ item }}.crt
        }

        # Child SA
        children {
            algovpn-pq-tunnel {
                remote_ts = 0.0.0.0/0
                esp_proposals = {{ ciphers.quantum_safe.hybrid.esp if quantum_safe_mode == 'hybrid' else ciphers.defaults.esp }}
                mode = tunnel
                start_action = start
                close_action = trap
            }
        }

        # Auto-connect
        auto = start
    }
}

# Required certificates and keys:
# - Place {{ item }}.crt in /etc/swanctl/x509/
# - Place {{ item }}.key in /etc/swanctl/private/
# - Place cacert.pem in /etc/swanctl/x509ca/

# Verification:
# swanctl --load-all
# swanctl --list-conns
# swanctl --initiate --child algovpn-pq-tunnel
