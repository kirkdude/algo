#!/bin/bash
# Performance benchmark script for quantum-safe algorithms
# Generated by Ansible for Algo Quantum VPN

set -e

LIBOQS_BUILD_DIR="{{ liboqs_build_dir }}"
BENCHMARK_LOG="/opt/quantum-safe/logs/benchmark-$(date +%Y%m%d_%H%M%S).log"

echo "=== Quantum-Safe Performance Benchmarks ===" | tee "$BENCHMARK_LOG"
echo "Timestamp: $(date)" | tee -a "$BENCHMARK_LOG"
echo "System: $(uname -a)" | tee -a "$BENCHMARK_LOG"
echo "CPU: $(grep 'model name' /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)" | tee -a "$BENCHMARK_LOG"
echo "Memory: $(free -h | grep '^Mem:' | awk '{print $2}')" | tee -a "$BENCHMARK_LOG"
echo "liboqs Build Directory: $LIBOQS_BUILD_DIR" | tee -a "$BENCHMARK_LOG"
echo "" | tee -a "$BENCHMARK_LOG"

# Benchmark ML-KEM algorithms
echo "=== ML-KEM (Key Encapsulation Mechanism) Benchmarks ===" | tee -a "$BENCHMARK_LOG"
{% for algorithm in quantum_safe_algorithms.ml_kem %}
echo "Benchmarking {{ algorithm }}..." | tee -a "$BENCHMARK_LOG"
echo "----------------------------------------" | tee -a "$BENCHMARK_LOG"
if "$LIBOQS_BUILD_DIR/tests/speed_kem" "{{ algorithm }}" 2>&1 | tee -a "$BENCHMARK_LOG"; then
    echo "{{ algorithm }} benchmark completed successfully" | tee -a "$BENCHMARK_LOG"
else
    echo "{{ algorithm }} benchmark failed" | tee -a "$BENCHMARK_LOG"
fi
echo "" | tee -a "$BENCHMARK_LOG"
{% endfor %}

# Benchmark ML-DSA algorithms
echo "=== ML-DSA (Digital Signature Algorithm) Benchmarks ===" | tee -a "$BENCHMARK_LOG"
{% for algorithm in quantum_safe_algorithms.ml_dsa %}
echo "Benchmarking {{ algorithm }}..." | tee -a "$BENCHMARK_LOG"
echo "----------------------------------------" | tee -a "$BENCHMARK_LOG"
if "$LIBOQS_BUILD_DIR/tests/speed_sig" "{{ algorithm }}" 2>&1 | tee -a "$BENCHMARK_LOG"; then
    echo "{{ algorithm }} benchmark completed successfully" | tee -a "$BENCHMARK_LOG"
else
    echo "{{ algorithm }} benchmark failed" | tee -a "$BENCHMARK_LOG"
fi
echo "" | tee -a "$BENCHMARK_LOG"
{% endfor %}

# Memory usage analysis
echo "=== Memory Usage Analysis ===" | tee -a "$BENCHMARK_LOG"
echo "Current memory usage:" | tee -a "$BENCHMARK_LOG"
free -h | tee -a "$BENCHMARK_LOG"
echo "" | tee -a "$BENCHMARK_LOG"

# System performance context
echo "=== System Performance Context ===" | tee -a "$BENCHMARK_LOG"
echo "Load average: $(uptime | awk -F'load average:' '{print $2}')" | tee -a "$BENCHMARK_LOG"
echo "CPU usage: $(top -bn1 | grep 'Cpu(s)' | awk '{print $2}' | cut -d'%' -f1)" | tee -a "$BENCHMARK_LOG"

echo "=== Benchmark Summary ===" | tee -a "$BENCHMARK_LOG"
echo "All benchmarks completed at $(date)" | tee -a "$BENCHMARK_LOG"
echo "Full results saved to: $BENCHMARK_LOG"
echo ""
echo "Note: These benchmarks are for development reference only."
echo "Production performance will vary based on hardware and network conditions."
